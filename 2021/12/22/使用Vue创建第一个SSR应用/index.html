<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon-32x32-next.png?v=5.1.4" color="#222">





  <meta name="keywords" content="Vue,">





  <link rel="alternate" href="/atom.xml" title="Ren's Blog" type="application/atom+xml">






<meta name="description" content="什么是 SSR?SSR 全拼为 Server-Side Render，意思为服务端渲染。Vue 本身是一个客户端程序的渲染框架，运行环境通常是浏览器、webview 和 electron 等。他的作用主要是将 Vue 组件转换成客户端可用的代码片段，来生成 DOM 和操作 DOM。而服务端渲染指的是在服务端将客户端所需加载渲染的 HTML 一次性转成字符串返回给客户端渲染，最后将这些静态标记激活成">
<meta name="keywords" content="Vue">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Vue创建第一个SSR应用">
<meta property="og:url" content="http://yoursite.com/2021/12/22/使用Vue创建第一个SSR应用/index.html">
<meta property="og:site_name" content="Ren&#39;s Blog">
<meta property="og:description" content="什么是 SSR?SSR 全拼为 Server-Side Render，意思为服务端渲染。Vue 本身是一个客户端程序的渲染框架，运行环境通常是浏览器、webview 和 electron 等。他的作用主要是将 Vue 组件转换成客户端可用的代码片段，来生成 DOM 和操作 DOM。而服务端渲染指的是在服务端将客户端所需加载渲染的 HTML 一次性转成字符串返回给客户端渲染，最后将这些静态标记激活成">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/images/vue-ssr/1.png">
<meta property="og:image" content="http://yoursite.com/images/vue-ssr/2.png">
<meta property="og:image" content="http://yoursite.com/images/vue-ssr/3.png">
<meta property="og:updated_time" content="2021-12-23T02:48:53.905Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用Vue创建第一个SSR应用">
<meta name="twitter:description" content="什么是 SSR?SSR 全拼为 Server-Side Render，意思为服务端渲染。Vue 本身是一个客户端程序的渲染框架，运行环境通常是浏览器、webview 和 electron 等。他的作用主要是将 Vue 组件转换成客户端可用的代码片段，来生成 DOM 和操作 DOM。而服务端渲染指的是在服务端将客户端所需加载渲染的 HTML 一次性转成字符串返回给客户端渲染，最后将这些静态标记激活成">
<meta name="twitter:image" content="http://yoursite.com/images/vue-ssr/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/12/22/使用Vue创建第一个SSR应用/">





<!-- 网页加载条 -->
<script src="https://neveryu.github.io/js/src/pace.min.js"></script>
  <title>使用Vue创建第一个SSR应用 | Ren's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ren's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">时间仍在，是我们在飞逝</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            公益404
          </a>
        </li>
      

      

  
</ul></nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/22/使用Vue创建第一个SSR应用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ren">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ren's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">使用Vue创建第一个SSR应用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-12-22T17:17:51+08:00">
                2021-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-eye"></i> 热度
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>℃
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6.8k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  29 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="什么是-SSR"><a href="#什么是-SSR" class="headerlink" title="什么是 SSR?"></a>什么是 SSR?</h2><p>SSR 全拼为 Server-Side Render，意思为服务端渲染。Vue 本身是一个客户端程序的渲染框架，运行环境通常是浏览器、webview 和 electron 等。他的作用主要是将 Vue 组件转换成客户端可用的代码片段，来生成 DOM 和操作 DOM。而服务端渲染指的是在服务端将客户端所需加载渲染的 HTML 一次性转成字符串返回给客户端渲染，最后将这些静态标记激活成浏览器端完全可以运行的程序。部分 Vue 的代码会同时在客户端和服务端都会被执行，所以服务端渲染一般也会被称作为同构。</p>
<h2 id="为什么要使用-SSR？"><a href="#为什么要使用-SSR？" class="headerlink" title="为什么要使用 SSR？"></a>为什么要使用 SSR？</h2><p>说到这，就需要先了解单页面应用（SPA）和预渲染（Prerendering）。</p>
<a id="more"></a>
<p>一般来说，我们通常所用的 Vue 搭建的应用都是 SPA(Single-Page Application)，即创建单个 HTML，在 HTML 中创建 JS 应用，由 JS 控制路由，根据路由的变化，动态加载组件。</p>
<p>预渲染则是在单页面构建过程中，将每个路由单独拆分成独立的 HTML（在 webpack 中使用<a href="https://github.com/chrisvfritz/prerender-spa-plugin" target="_blank" rel="noopener">prerender-spa-plugin</a>插件），在浏览器访问中访问到的则是独立的页面。</p>
<p>就 SEO 来说，SPA 经历了 HTML 加载、JS 应用加载、数据加载这三个步骤才能完全展示页面，而往往爬虫在 HTML 加载完成之后就会认为页面已经加载完成，无法获取更多的页面信息，所以 SPA 对 SEO 并不是十分的友好；Prerendering 由于是构建成了独立的 HTML，所以在 HTML 加载的过程中能够加载更多的内容，爬虫自然也是能抓取到更多的信息，SEO 较 SPA 更好一些。但是有一个关键的点就是 Prerendering 的 HTML 生成的时机是构建的时候，所以 Prerendering 无法对数据进行填充，访问到的只是一个有着静态 DOM 但是没有填充数据的 HTML。SSR 由于是在服务端动态生成的 HTML 流文件，所以可以进行数据的预填充。</p>
<p>所以 SSR 的优点如下：</p>
<ul>
<li>更好的 SEO，搜索引擎的爬虫可以直接抓取完全生成好的页面，获取到更多的信息。</li>
<li>更快的首屏加载速度，服务端直接返回页面的渲染的静态文件，浏览器无需等待 js 下载完成就可以直接渲染出首屏。</li>
</ul>
<p>同样的，SSR 也有相对应的缺点：</p>
<ul>
<li>开发环境受限，因为有些代码需要同时运行在浏览器端和服务端，所以浏览器端特定的代码需要在特定的声明周期内运行，例如操作 DOM 的操作，所以在开发过程中要注意</li>
<li>部署环境受限，相对于 SPA 来说，SPA 最终的部署文件是静态文件，可以部署到任意服务器中，而服务端渲染由于借助 NodeJS，所以必须部署在有服务端代码存在的服务端中（2.5 版本之前只支持 node 部署，2.5 之后可以支持在 php-v8js，Oracle Nashorn 中部署）</li>
<li>服务端负载提升，由于每次初始渲染都需要服务端加载做静态资源的编译，所以需要占用一定的服务器资源</li>
</ul>
<p>但是不是所有的场景都适合使用 SSR，最根本的还是根据不同的业务需求选择最适合的方案。</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>SPA</th>
<th>Prerendering</th>
<th>SSR</th>
</tr>
</thead>
<tbody>
<tr>
<td>项目结构</td>
<td>容器 HTML+多个页面组件或者模块组件</td>
<td>页面 HTML+模块组件</td>
<td>HTML 流文件+多个页面组件或者模块组件</td>
</tr>
<tr>
<td>用户体验</td>
<td>首屏加载受资源加载速度的影响，速度较慢,切换路由由 js 动态加载，速度较快</td>
<td>页面的 HTML 加载完成之后即可展示，速度较快,切换路由需要重新加载页面（公共的静态资源可以从缓存中获取），速度一般</td>
<td>首页的加载受服务器性能影响，一般来说较快,切换路由由 js 控制，速度较快</td>
</tr>
<tr>
<td>SEO</td>
<td>较差，需借助 meta 标签提升 SEO</td>
<td>较好</td>
<td>较好</td>
</tr>
<tr>
<td>开发环境</td>
<td>代码只在客户端运行，只需要注意客户端的开发问题</td>
<td>代码只在客户端运行，只需要注意客户端的开发问题</td>
<td>代码需要同时在客户端和服务端同时运行，在开发的时候需要多加注意，由于在服务端运行时只有 create 和 created 这两个生命周期，所以使用的第三方的插件也需要特比关注</td>
</tr>
<tr>
<td>部署环境</td>
<td>构建之后的代码仅仅是静态文件，所以可以部署在任意的服务器中</td>
<td>构建之后的代码仅仅是静态文件，所以可以部署在任意的服务器中</td>
<td>需要借助服务端才能完成部署</td>
</tr>
<tr>
<td>使用场景</td>
<td>不需要特别关注 SEO 的场景，如后台管理系统</td>
<td>需要关注 SEO，或者页面加载时间要求比较短但是不需要预填充数据的场景，比如公司的官网</td>
<td>对 SEO 要求较高，要求页面加载时间短并且需要数据预填充的场景，比如电商网站的首页，门户网站的首页，博客、论坛、新闻资讯类的页面等</td>
</tr>
</tbody>
</table>
<h2 id="了解-ssr-的基本原理和渲染过程"><a href="#了解-ssr-的基本原理和渲染过程" class="headerlink" title="了解 ssr 的基本原理和渲染过程"></a>了解 ssr 的基本原理和渲染过程</h2><p>做个对比</p>
<p>先看一下 SPA 的加载过程：<br><img src="/images/vue-ssr/1.png" alt="SPA加载的过程"></p>
<p>一个 SPA 项目的页面被访问时，大致上有这几个过程：</p>
<ol>
<li>浏览器访问获取 index.html 并加载 index.html。</li>
<li>解析 html 中的资源，并进行下载执行。最核心的是 app.js（入口文件），执行 app.js 激活应用程序，然后根据当前的路由添加对应的静态资源路径到 html 中。</li>
<li>执行下载完成的 js 文件，转换成组件挂载到页面当中。</li>
<li>页面数据请求，渲染返回的数据。</li>
<li>路由切换，app 添加对应的资源到页面，解析完成切换</li>
</ol>
<p>接下来了解一下 SSR 一个基本的加载和执行的过程：<br><img src="/images/vue-ssr/2.png" alt="SPA加载的过程"></p>
<p>当客户端访问页面时，客户端首先会向服务端请求 HTML 页面，由于首页是在服务端渲染完成之后才被返回的，所以服务端需要根据客户端传递过来的地址，获取相应的组件，然后将组件转换成字符串之后拼接成一个完整的 html，返回给客户端。客户端在拿到文件流之后，对 HTML 文件进行一个解析渲染。由于拿到的文件是已经渲染好的页面，不需要做页面的渲染，但是仍然需要激活程序（执行 app.js），同步页面数据和状态（这里和 SPA 不同的地方是，<strong>SPA 是先加载 app.js，由 app.js 决定当前页面要加载哪些资源，在 SPA 中，首屏需要的静态资源都会被注入到 HTML 中一次性返回，不需要 app.js 控制</strong>）。当用户切换路由时，客户端要根据程序加载路由对应的静态资源文件并下载执行来切换路由，此时下载的静态文件只需要从已经打包生成好的静态资源文件中直接获取即可，不需要服务器再根据路由动态生成。</p>
<p><img src="/images/vue-ssr/3.png" alt></p>
<p><strong>如何获取对应的组件，将组件转换成字符串？</strong></p>
<p>在实际的部署当中，所有的前端代码都会被 build 成静态资源，并且会对代码进行压缩。服务端在渲染首屏的时候需要根据路由匹配静态资源，vue 提供一个<code>**vue-server-renderer**</code>的插件，这个插件可以将组件编译成静态的 html 文件，并且会在 webpack 打包的时候记录静态资源的对应关系的 JSON 文件。</p>
<p><strong>vue-server-renderer</strong></p>
<p>vue-server-renderer 提供两种 renderer 函数：renderer 和 bundleRenderer。renderer 函数由 createRenderer 函数生成，bundleRenderer 由 createBundleRenderer 函数生成，bundleRender 实际上是从 renderer 上做了扩展。这两个 renderer 都是将组件编译成字符串输，区别在于 renderer 是对组件进行的编译，bundleRenderer 是对 build 之后的静态资源文件进行编译，相对应 renderer 来说，bundleRenderer 支持更多的功能：</p>
<ul>
<li>支持 sourceMap</li>
<li>支持热重载</li>
<li>支持资源注入</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createRenderer&#125; = <span class="built_in">require</span>(<span class="string">"vue-server-renderer"</span>)</span><br><span class="line"><span class="keyword">const</span> renderer = createRenderer(&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">renderer.renderToString(vm, context, (err, html) =&gt; &#123;&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createBundleRenderer&#125; = <span class="built_in">require</span>(<span class="string">"vue-server-renderer"</span>)</span><br><span class="line"><span class="keyword">const</span> renderer = createBundleRenderer(&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">renderer.renderToString(context, (err, html) =&gt; &#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>renderer 的用法</p>
<p>bundleRenderer 的用法</p>
<p>vue-server-renderer 还提供了两个 webpack 插件：server-plugin 和 client-plugin。server-plugin 用来生成服务端静态资源 vue-ssr-server-bundle.json，client 用来生成 vue-ssr-client-manifest.json。</p>
<p>vue-ssr-client-manifest.json 中记录了 webpack 打包过程中文件生成的记录，每个模块对应哪一段 hash 值，哪些资源首屏需要加载，哪些资源需要动态加载，这些内容都是用来优化首屏资源加载的。</p>
<p>vue-ssr-server-bundle.json 主要是存储了组件编译之后的代码，还记录了 sourcemap，用来提示服务端执行时的错误检查。</p>
<h2 id="构建一个基础的服务"><a href="#构建一个基础的服务" class="headerlink" title="构建一个基础的服务"></a>构建一个基础的服务</h2><hr>
<h3 id="所需环境"><a href="#所需环境" class="headerlink" title="所需环境"></a>所需环境</h3><hr>
<ul>
<li><p>vue-server-renderer</p>
<p><strong>vue-server-renderer 一定要和 vue 的版本一致</strong></p>
</li>
<li><p>vue</p>
</li>
<li>express</li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add vue express vue-server-render -S</span><br></pre></td></tr></table></figure>
<h3 id="创建页面模板"><a href="#创建页面模板" class="headerlink" title="创建页面模板"></a>创建页面模板</h3><hr>
<p>由于在服务端需要返回一段已经编译完成的 HTML 流文件，所以需要提前准备一个 HTML 模板，用来编译使用。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    &#123;&#123;&#123;meta&#125;&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--vue-ssr-outlet--&gt;</span></span><br><span class="line"></span><br><span class="line">    /** 在这里面，使用“&#123;&#123; &#125;&#125;”来为 vue 提供插值的插槽，由于 vue</span><br><span class="line">    会对特殊字符进行转义，所以会通过“&#123;&#123;&#123; &#125;&#125;&#125;”提供一个不转义的插槽。</span><br><span class="line">    其中还发现页面中还有一段注释“<span class="comment">&lt;!--vue-ssr-outlet--&gt;</span>” ，这是为应用程序标记为</span><br><span class="line">    HTML 注入的地方（这里和 SPA 做区别） */</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建服务和-Vue-实例"><a href="#创建服务和-Vue-实例" class="headerlink" title="创建服务和 Vue 实例"></a>创建服务和 Vue 实例</h3><hr>
<p>创建服务端应用时有两个关键的步骤：</p>
<ul>
<li>创建 Vue 应用插入到模板中，然后转换为字符串输出</li>
<li>服务端拦截请求，返回编译好的字符串</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">"express"</span>)();</span><br><span class="line"><span class="keyword">const</span> Vue = <span class="built_in">require</span>(<span class="string">"Vue"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; createRenderer &#125; = <span class="built_in">require</span>(<span class="string">"vue-server-renderer"</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = fs.readFileSync(<span class="string">"./public/index.html"</span>, <span class="string">"utf-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个render，用来将Vue实例编译并插入到HTML中</span></span><br><span class="line"><span class="keyword">const</span> renderer = createRenderer(&#123;</span><br><span class="line">  template</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Vue实例</span></span><br><span class="line"><span class="keyword">const</span> vueApp = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  template: <span class="string">"&lt;div&gt;hello world&lt;/div&gt;"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截路由</span></span><br><span class="line">app.use(<span class="string">"*"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> url = req.url;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = &#123;</span><br><span class="line">    url: url,</span><br><span class="line">    title: <span class="string">"vue ssr"</span>,</span><br><span class="line">    meta: <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;meta name="keyword" content="vue,ssr"&gt;</span></span><br><span class="line"><span class="string">            &lt;meta name="description" content="vue srr demo"&gt;</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将Vue实例渲染成HTML</span></span><br><span class="line">  renderer.renderToString(vueApp, context, (err, html) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      res.send(<span class="number">500</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.send(html);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Server in running on http://localhost:3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然后就可以在浏览器访问<code>http://localhost:3000</code> 查看服务端返回的页面。</p>
<h2 id="改造"><a href="#改造" class="headerlink" title="改造"></a>改造</h2><hr>
<p>在上面的服务中，我们构建了一个基础的 Node 端服务并返回了一个简单的 Vue 程序，但是这个服务过于简单，有很多的需要完善的地方：</p>
<ul>
<li>多次请求返回的都是同一个 Vue 实例，这会导致每次请求产生的数据都会缓存到内存中，后续每次的组件都能获取到之前的请求产生的数据</li>
<li>当页面比较复杂时，Vue 有很多的代码需要编译处理，我们需要添加 Webpack 来处理相关过程</li>
</ul>
<p>所以接下来的工作大致如下：</p>
<ul>
<li>创建实例工厂，为每个请求都返回一个 Vue 实例</li>
<li>添加 Webpack 相关的配置，修改当前的目录结构以适配客户端和服务端的 webpack 配置</li>
</ul>
<h3 id="所需环境-1"><a href="#所需环境-1" class="headerlink" title="所需环境"></a>所需环境</h3><hr>
<ul>
<li>vue-router</li>
<li>vue-template-compiler</li>
<li>webpack</li>
</ul>
<h3 id="改造后的目录结构"><a href="#改造后的目录结构" class="headerlink" title="改造后的目录结构"></a>改造后的目录结构</h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">|-- components</span><br><span class="line">|   |-- A.vue</span><br><span class="line">|   |-- B.vue</span><br><span class="line">|-- App.vue</span><br><span class="line">|-- app.js</span><br><span class="line">|-- entry-client.js</span><br><span class="line">|-- entry-server.js</span><br><span class="line">|-- router.js</span><br></pre></td></tr></table></figure>
<p>改造后的目录结构如上，<code>App.vue</code> 为 Vue 程序的顶层组件，<code>app.js</code>为实例工厂，<code>entry-client</code>和<code>entry-server</code>分别为客户端和服务端的入口文件。</p>
<h3 id="提取实例工厂，创建路由"><a href="#提取实例工厂，创建路由" class="headerlink" title="提取实例工厂，创建路由"></a>提取实例工厂，创建路由</h3><hr>
<p>由于访问到的后端页面可能是任意页面，所以每次返回的都需要包含 App 这个页面组件，所以实际上<code>app.js</code>中返回的都是一个以 App 为入口的组件实例。</p>
<p><strong>app.js</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">"./App.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> createRouter <span class="keyword">from</span> <span class="string">"./router.js"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./test.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> router = createRouter();</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    router,</span><br><span class="line">    template: <span class="string">"&lt;App /&gt;"</span>,</span><br><span class="line">    components: &#123; App &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> &#123; app, router &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时创建一个路由的工厂</p>
<p><strong>router.js</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">"vue-router"</span>;</span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span>;</span><br><span class="line">Vue.use(Router);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> router = <span class="keyword">new</span> Router(&#123;</span><br><span class="line">    mode: <span class="string">"history"</span>,</span><br><span class="line">    routes: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">"/"</span>,</span><br><span class="line">        component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"./components/A.vue"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> router;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们就可以调用 createApp 这个方法动态生成组件。</p>
<h3 id="创建客户端入口文件-entry-client-js"><a href="#创建客户端入口文件-entry-client-js" class="headerlink" title="创建客户端入口文件 entry-client.js"></a>创建客户端入口文件 entry-client.js</h3><hr>
<p>该入口文件作为客户端的入口文件，实际上是作为打包的入口文件，在实际代码中不做引用</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createApp &#125; = <span class="built_in">require</span>(<span class="string">"./app"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; app, router &#125; = createApp();</span><br><span class="line"></span><br><span class="line">router.onReady(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Ready to mount app"</span>);</span><br><span class="line">  app.$mount(<span class="string">"#app"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="创建服务端入口文件-entry-server-js"><a href="#创建服务端入口文件-entry-server-js" class="headerlink" title="创建服务端入口文件 entry-server.js"></a>创建服务端入口文件 entry-server.js</h3><hr>
<p>该入口文件为服务端的入口文件，实际是最为服务端渲染打打包入口文件，服务端不需要做太多东西，我们只需要获取要请求的页面的路由，等待路由加载完成，并将对应的组件填入数据返回回去做渲染即可。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createApp &#125; = <span class="built_in">require</span>(<span class="string">"./app"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">context</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; app, router &#125; = createApp();</span><br><span class="line"></span><br><span class="line">    router.push(context.url);</span><br><span class="line">    <span class="comment">// 等待路由挂载结束</span></span><br><span class="line">    router.onReady(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> matchedComponents = router.getMatchedComponents();</span><br><span class="line">      <span class="comment">// 没有匹配到路由返回404</span></span><br><span class="line">      <span class="keyword">if</span> (!matchedComponents.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(&#123;</span><br><span class="line">          code: <span class="number">404</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 匹配到路由返回app</span></span><br><span class="line">      resolve(app);</span><br><span class="line">    &#125;, reject);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="添加-webpack-配置"><a href="#添加-webpack-配置" class="headerlink" title="添加 webpack 配置"></a>添加 webpack 配置</h3><hr>
<p>创建好了入口文件，还需要针对浏览器端和服务端分别添加 webpack 的配置文件。配置文件分为三个，一个公共的配置文件—webpack.base.config.js，浏览器端的配置文件—webpack.client.config.js，服务端的配置文件—webpack.server.config.js。</p>
<p>需要配置的大概有：</p>
<ul>
<li>entry：设置入口文件</li>
<li>output：输出配置，path、filename、publicPath</li>
<li>module：配置一些常见的 loader 如 vue-loader，js 相关的 loader，css 相关的 loader 等</li>
<li>plugins：配置一些需要用的配置的插件</li>
<li>resolve：一些路径相关的配置项</li>
</ul>
<p><strong>webpack.base.config.js</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> VueLoaderPlugin = <span class="built_in">require</span>(<span class="string">"vue-loader/lib/plugin"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; CleanWebpackPlugin &#125; = <span class="built_in">require</span>(<span class="string">"clean-webpack-plugin"</span>);</span><br><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">"mini-css-extract-plugin"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">"production"</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(<span class="string">"dist"</span>),</span><br><span class="line">    filename: <span class="string">"[name].js"</span>,</span><br><span class="line">    publicPath: <span class="string">"/"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        loader: <span class="string">"vue-loader"</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          extractCss: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        loader: <span class="string">"babel-loader"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        loader: [MiniCssExtractPlugin.loader, <span class="string">"css-loader"</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        loader: [MiniCssExtractPlugin.loader, <span class="string">"css-loader"</span>, <span class="string">"sass-loader"</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin(&#123;</span><br><span class="line">      cleanOnceBeforeBuildPatterns:</span><br><span class="line">        process.env.NODE_VUE == <span class="string">"server"</span> ? [] : [<span class="string">"**/*"</span>, <span class="string">"!*.json"</span>]</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> VueLoaderPlugin(),</span><br><span class="line">    <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">      filename: <span class="string">"css/[name].[contenthash].css"</span>,</span><br><span class="line">      chunkFilename: <span class="string">"css/[id].[contenthash].css"</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里需要注意的是，我们在配置中获取的环境变量<code>process.env.NODE_VUE</code>来判断是否需要清空<code>dist</code>下的指定文件，这里使用了<code>cross-env</code>这个包来指定了环境变量，在<code>package.json</code>中的脚本前添加<code>cross-env NODE_VUE=server</code></p>
</blockquote>
<p>接下来配置浏览器端打包的配置文件，引入 base.config.js 然后用 webpack-merge 做合并。在浏览器端，我们需要将剩余的未添加的配置补齐，例如入口文件，输出的文件名，一些文件转换的 loader，插件等</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; merge &#125; = <span class="built_in">require</span>(<span class="string">"webpack-merge"</span>);</span><br><span class="line"><span class="keyword">const</span> baseConfig = <span class="built_in">require</span>(<span class="string">"./webpack.base.config"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> VueSSRClientPlugin = <span class="built_in">require</span>(<span class="string">"vue-server-renderer/client-plugin"</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(baseConfig, &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: path.resolve(<span class="string">"src/entry-client.js"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">"js/[name].[chunkhash].js"</span>,</span><br><span class="line">    chunkFilename: <span class="string">"js/[id].[chunkhash].js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: []</span><br><span class="line">  &#125;,</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      name: <span class="string">"manifest"</span>,</span><br><span class="line">      minChunks: <span class="literal">Infinity</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [<span class="keyword">new</span> VueSSRClientPlugin()]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>接下来是服务端的打包配置，同样引入 base.config.js，但是不同的是 target 要设置为 node，输出模块要改为 node 的 commojs</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> baseConfig = <span class="built_in">require</span>(<span class="string">"./webpack.base.config"</span>);</span><br><span class="line"><span class="keyword">const</span> nodeExternals = <span class="built_in">require</span>(<span class="string">"webpack-node-externals"</span>);</span><br><span class="line"><span class="keyword">const</span> VueSSRServerPlugin = <span class="built_in">require</span>(<span class="string">"vue-server-renderer/server-plugin"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; merge &#125; = <span class="built_in">require</span>(<span class="string">"webpack-merge"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(baseConfig, &#123;</span><br><span class="line">  target: <span class="string">"node"</span>,</span><br><span class="line">  devtool: <span class="string">"source-map"</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: path.resolve(<span class="string">"src/entry-server.js"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    libraryTarget: <span class="string">"commonjs2"</span>,</span><br><span class="line">    filename: <span class="string">"server-bundle.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  externals: nodeExternals(&#123;</span><br><span class="line">    allowlist: <span class="regexp">/\.css$/</span></span><br><span class="line">  &#125;),</span><br><span class="line">  plugins: [<span class="keyword">new</span> VueSSRServerPlugin()]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="在-Node-中读取配置，根据-bundle-返回资源"><a href="#在-Node-中读取配置，根据-bundle-返回资源" class="headerlink" title="在 Node 中读取配置，根据 bundle 返回资源"></a>在 Node 中读取配置，根据 bundle 返回资源</h3><hr>
<p>完成上述配置后，我们进行打包操作，打包完成后，会在根目录生成 dist 目录，里面包含打包好的静态资源文件和两个 bundle 文件。</p>
<p>我们在服务端可以读取两个 bundle 的信息，根据这两个 bundle 读取静态资源，这是就要用上 vue-server-renderer 提供的 createBundleRenderer 方法来生成 renderer 对象了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">"express"</span>)();</span><br><span class="line"><span class="keyword">const</span> Vue = <span class="built_in">require</span>(<span class="string">"Vue"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; createBundleRenderer &#125; = <span class="built_in">require</span>(<span class="string">"vue-server-renderer"</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = fs.readFileSync(<span class="string">"./public/index.html"</span>, <span class="string">"utf-8"</span>);</span><br><span class="line"><span class="keyword">const</span> serverBundle = fs.readFileSync(<span class="string">"./dist/vue-ssr-server-bundle.json"</span>);</span><br><span class="line"><span class="keyword">const</span> clientManifest = fs.readFileSync(<span class="string">"./dist/vue-ssr-client-manifest.json"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个render，用来将Vue实例编译并插入到HTML中</span></span><br><span class="line"><span class="keyword">const</span> renderer = createBundleRenderer(serverBundle, &#123;</span><br><span class="line">  runInNewContext: <span class="literal">false</span>,</span><br><span class="line">  template,</span><br><span class="line">  clientManifest</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截路由</span></span><br><span class="line">app.use(<span class="string">"*"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> url = req.url;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = &#123;</span><br><span class="line">    url: url,</span><br><span class="line">    title: <span class="string">"vue ssr"</span>,</span><br><span class="line">    meta: <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;meta name="keyword" content="vue,ssr"&gt;</span></span><br><span class="line"><span class="string">            &lt;meta name="description" content="vue srr demo"&gt;</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将Vue实例渲染成HTML</span></span><br><span class="line">  renderer.renderToString(context, (err, html) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      res.send(<span class="number">500</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.send(html);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Server in running on http://localhost:3000"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样重新启动服务，通过访问<code>http://localhost:3000</code>就能看到返回的页面了</p>
<h2 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h2><hr>
<p>在上面搭建的过程中，发现每次想修改代码内容，都需要重新打包，然后重启服务，非常的麻烦，所以是不是可以搭建一套本地的开发环境，支持客户端代码的热更新、热部署，服务端代码支持自动加载编译呢？</p>
<h3 id="所需环境-2"><a href="#所需环境-2" class="headerlink" title="所需环境"></a>所需环境</h3><hr>
<ul>
<li>nodemon</li>
<li>webpack-dev-middleware</li>
<li>webpack-hot-middleware</li>
<li>memory-fs</li>
</ul>
<h3 id="服务端热更新"><a href="#服务端热更新" class="headerlink" title="服务端热更新"></a>服务端热更新</h3><hr>
<p>服务端的热更新比较简便，只要是用<code>nodemon</code>启动我们的服务即可实现代码保存，自动更新。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodemon server.js</span><br></pre></td></tr></table></figure>
<h3 id="客户端热更新"><a href="#客户端热更新" class="headerlink" title="客户端热更新"></a>客户端热更新</h3><hr>
<p>客户端代码的热更新相对服务端来说复杂一些，像普通的 webpack 构建的项目中，我们通常以 webpack 的 devServer 搭配 HotReplacePlugin 完成热更新的工作。在 node 中我们则需要借助 webpack-hot-middleware 和 webpack-dev-middleware 这两个中间件来完成热更新和热部署。</p>
<p>首先我们来对 server.js 进行改造，想之前的那些代码都是运行在生产环境的，但是 renderer 还是同一个 renderer，所以我们需要根据环境判断再生成一个开发环境的 renderer 即可。</p>
<p><strong>server.js</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">"express"</span>)();</span><br><span class="line"><span class="keyword">const</span> &#123; createBundleRenderer &#125; = <span class="built_in">require</span>(<span class="string">"vue-server-renderer"</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> setupDevServer = <span class="built_in">require</span>(<span class="string">"./build/devServer"</span>);</span><br><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">"chalk"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = fs.readFileSync(<span class="string">"./public/index.html"</span>, <span class="string">"utf-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isProduction = process.env.NODE_ENV == <span class="string">"production"</span>;</span><br><span class="line"><span class="keyword">let</span> renderer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isProduction) &#123;</span><br><span class="line">  <span class="keyword">const</span> serverBundle = <span class="built_in">require</span>(<span class="string">"./dist/vue-ssr-server-bundle.json"</span>);</span><br><span class="line">  <span class="keyword">const</span> clientManifest = <span class="built_in">require</span>(<span class="string">"./dist/vue-ssr-client-manifest.json"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个render，用来将Vue实例编译并插入到HTML中</span></span><br><span class="line">  renderer = createBundleRenderer(serverBundle, &#123;</span><br><span class="line">    runInNewContext: <span class="literal">false</span>,</span><br><span class="line">    template,</span><br><span class="line">    clientManifest</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  setupDevServer(app, <span class="function"><span class="keyword">function</span> (<span class="params">serverBundle, clientManifest</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"get bundle"</span>);</span><br><span class="line">    renderer = createBundleRenderer(serverBundle, &#123;</span><br><span class="line">      runInNewContext: <span class="literal">false</span>,</span><br><span class="line">      template,</span><br><span class="line">      clientManifest</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截路由</span></span><br><span class="line">app.use(<span class="string">"/"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> url = req.url;</span><br><span class="line">  <span class="built_in">console</span>.log(url);</span><br><span class="line">  <span class="keyword">const</span> context = &#123;</span><br><span class="line">    url: url,</span><br><span class="line">    title: <span class="string">"vue ssr"</span>,</span><br><span class="line">    meta: <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;meta name="keyword" content="vue,ssr"&gt;</span></span><br><span class="line"><span class="string">            &lt;meta name="description" content="vue srr demo"&gt;</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将Vue实例渲染成HTML</span></span><br><span class="line">  renderer.renderToString(context, (err, html) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(html);</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">      res.status(err.code).end(<span class="string">"Internal Server Error"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.end(html);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(chalk.green(<span class="string">"\nServer in running on http://localhost:3000 \n"</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在创建服务端服务器的代码中，我们对浏览器端的 bundle 和服务端的 bundle 进行监听，一旦发生改变，就进行更新。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> clientConfig = <span class="built_in">require</span>(<span class="string">"./webpack.client.config"</span>);</span><br><span class="line"><span class="keyword">const</span> serverConfig = <span class="built_in">require</span>(<span class="string">"./webpack.server.config"</span>);</span><br><span class="line"><span class="keyword">const</span> WebpackHotMiddleware = <span class="built_in">require</span>(<span class="string">"webpack-hot-middleware"</span>);</span><br><span class="line"><span class="keyword">const</span> WebpackDevMiddleware = <span class="built_in">require</span>(<span class="string">"webpack-dev-middleware"</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"><span class="keyword">const</span> Mfs = <span class="built_in">require</span>(<span class="string">"memory-fs"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; CleanWebpackPlugin &#125; = <span class="built_in">require</span>(<span class="string">"clean-webpack-plugin"</span>);</span><br><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">"chalk"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readFile = <span class="function">(<span class="params">fsModule, path</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fsModule.readFileSync(path, <span class="string">"utf-8"</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">setupDevServer</span>(<span class="params">app, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> serverBundle, clientManifest;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当serverbundle或者clientManifest发生改变时，调用update</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (serverBundle &amp;&amp; clientManifest) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"will update"</span>);</span><br><span class="line">      cb(serverBundle, clientManifest);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据开发环境，对webpack配置做一些修改</span></span><br><span class="line">  clientConfig.entry.app = [</span><br><span class="line">    <span class="string">"webpack-hot-middleware/client"</span>,</span><br><span class="line">    clientConfig.entry.app</span><br><span class="line">  ];</span><br><span class="line">  clientConfig.devtool = <span class="string">"source-map"</span>;</span><br><span class="line">  clientConfig.output.filename = <span class="string">"[name].[hash].js"</span>;</span><br><span class="line">  clientConfig.plugins.push(<span class="keyword">new</span> webpack.HotModuleReplacementPlugin());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> clientCompiler = webpack(clientConfig),</span><br><span class="line">    devServerMiddleware = WebpackDevMiddleware(clientCompiler, &#123;</span><br><span class="line">      publicPath: clientConfig.output.publicPath,</span><br><span class="line">      noInfo: <span class="literal">true</span></span><br><span class="line">    &#125;),</span><br><span class="line">    hotReplaceMiddleware = WebpackHotMiddleware(clientCompiler);</span><br><span class="line"></span><br><span class="line">  app.use(devServerMiddleware);</span><br><span class="line">  app.use(hotReplaceMiddleware);</span><br><span class="line"></span><br><span class="line">  clientCompiler.hooks.done.tap(<span class="string">"done"</span>, (stats) =&gt; &#123;</span><br><span class="line">    stats = stats.toJson();</span><br><span class="line">    stats.errors.forEach(<span class="built_in">console</span>.error);</span><br><span class="line">    stats.warnings.forEach(<span class="built_in">console</span>.warn);</span><br><span class="line">    <span class="keyword">if</span> (stats.errors.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(chalk.blue(<span class="string">"client manifest build complete \n"</span>));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      clientManifest = <span class="built_in">JSON</span>.parse(</span><br><span class="line">        devServerMiddleware.fileSystem.readFileSync(</span><br><span class="line">          path.join(clientConfig.output.path, <span class="string">"vue-ssr-client-manifest.json"</span>)</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">      update();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      connsole.error(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> serverCompiler = webpack(serverConfig),</span><br><span class="line">    mfs = <span class="keyword">new</span> Mfs();</span><br><span class="line">  serverCompiler.outputFileSystem = mfs;</span><br><span class="line">  serverCompiler.watch(&#123;&#125;, (err, stats) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    stats = stats.toJson();</span><br><span class="line">    <span class="keyword">if</span> (stats.errors.length &gt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(chalk.blue(<span class="string">"server bundle build complete"</span>));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      serverBundle = <span class="built_in">JSON</span>.parse(</span><br><span class="line">        mfs.readFileSync(</span><br><span class="line">          path.join(serverConfig.output.path, <span class="string">"vue-ssr-server-bundle.json"</span>)</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">      update();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后通过启动 node 服务，这样就完成了开发环境的搭建。</p>
<h2 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h2><hr>
<p>日志管理我们采用<code>log4js-node</code> 来做日志的输出。</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add log4js -S</span><br></pre></td></tr></table></figure>
<h3 id="配置及封装"><a href="#配置及封装" class="headerlink" title="配置及封装"></a>配置及封装</h3><hr>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> log4j = <span class="built_in">require</span>(<span class="string">"log4js"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line">log4j.configure(&#123;</span><br><span class="line">  appenders: &#123;</span><br><span class="line">    info: &#123;</span><br><span class="line">      type: <span class="string">"file"</span>,</span><br><span class="line">      filename: path.resolve(<span class="string">"logs/info.log"</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    error: &#123;</span><br><span class="line">      type: <span class="string">"file"</span>,</span><br><span class="line">      filename: path.resolve(<span class="string">"logs/error.log"</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    consoleout: &#123;</span><br><span class="line">      type: <span class="string">"console"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  categories: &#123;</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      appenders: [<span class="string">"info"</span>, <span class="string">"consoleout"</span>],</span><br><span class="line">      level: <span class="string">"info"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    error: &#123;</span><br><span class="line">      appenders: [<span class="string">"error"</span>, <span class="string">"consoleout"</span>],</span><br><span class="line">      level: <span class="string">"error"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = log4j.getLogger(),</span><br><span class="line">  errorLogger = log4j.getLogger(<span class="string">"error"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  debug: <span class="function">(<span class="params">...params</span>) =&gt;</span> logger.debug(...params),</span><br><span class="line">  info: <span class="function">(<span class="params">...params</span>) =&gt;</span> logger.info(...params),</span><br><span class="line">  warn: <span class="function">(<span class="params">...params</span>) =&gt;</span> logger.warn(...params),</span><br><span class="line">  error: <span class="function">(<span class="params">...params</span>) =&gt;</span> errorLogger.error(...params),</span><br><span class="line">  fatal: <span class="function">(<span class="params">...params</span>) =&gt;</span> errorLogger.fatal(...params)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="数据获取和预渲染"><a href="#数据获取和预渲染" class="headerlink" title="数据获取和预渲染"></a>数据获取和预渲染</h2><hr>
<p>我们在响应请求返回页面时，如果页面上依赖一些后端的数据，往往需要做好数据预取并且填充好页面再返回页面做渲染。这里需要注意的是，客户端往往也需要同时初始化一份和服务端完全相同的数据，否则会因为一些状态类型的数据导致服务端和客户端的状态不一致，使应用程序发生错误。</p>
<h3 id="配置预取工具"><a href="#配置预取工具" class="headerlink" title="配置预取工具"></a>配置预取工具</h3><hr>
<p>Vue 应用程序搭配官方的状态管理框架 Vuex，数据请求框架我们将使用 axios。</p>
<p><strong>安装</strong></p>
<hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add vuex axios -S</span><br></pre></td></tr></table></figure>
<p><strong>创建 Store 文件</strong></p>
<hr>
<p>vuex 需要创建一个 rootStore 文件并将 store 添加到 vue 的实例中去，同时还需要将 router 的 state 同步到 store 中去</p>
<p><strong>store.js</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span>;</span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">"vuex"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Store &#125; = Vuex;</span><br><span class="line"></span><br><span class="line">Vue.use(Vuex);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Store(&#123;</span><br><span class="line">    store: &#123;&#125;,</span><br><span class="line">    mutations: &#123;&#125;,</span><br><span class="line">    actions: &#123;&#125;,</span><br><span class="line">    modules: &#123;&#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>app.js</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sync &#125; <span class="keyword">from</span> <span class="string">"vuex-router-sync"</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">"./App.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createRouter &#125; <span class="keyword">from</span> <span class="string">"./router.js"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">"./store.js"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./test.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> router = createRouter();</span><br><span class="line">  <span class="keyword">const</span> store = createStore();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把router的state同步到store中</span></span><br><span class="line">  sync(store, router);</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    router,</span><br><span class="line">    store,</span><br><span class="line">    <span class="comment">// template: "&lt;App /&gt;",</span></span><br><span class="line">    <span class="comment">// components: &#123; App &#125;,</span></span><br><span class="line">    render: <span class="function">(<span class="params">h</span>) =&gt;</span> h(App)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; app, router, store &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="组件的数据预取"><a href="#组件的数据预取" class="headerlink" title="组件的数据预取"></a>组件的数据预取</h3><hr>
<p>当然组件的数据预取我们也可以在组件的声明周期函数中进行，这里只说明在组件加载渲染之前的方式。这种方式为服务端渲染提供预取，服务端渲染提供了 asyncData 方法，支持我们在组件加载之前进行数据请求的操作，在组件中定了重写 asyncData 方法将在服务端渲染时用来预取数据</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    asyncData(&#123;isDev, route, store, env, params, query, req, res, redirect, error&#125;) &#123;</span><br><span class="line">        <span class="keyword">return</span> store.dispatch(<span class="string">"fetchData"</span>, route.params.id)</span><br><span class="line">    &#125;,</span><br><span class="line">		computed: &#123;</span><br><span class="line">				<span class="comment">// 可以通过 mapState 或者 this.$store.state 的形式获取数据</span></span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;style lang="scss" scoped&gt;&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure>
<h3 id="服务端数据预取"><a href="#服务端数据预取" class="headerlink" title="服务端数据预取"></a>服务端数据预取</h3><hr>
<p>在页面渲染之前，需要对页面中的数据做预取填充。我们将获取所有会被渲染的组件，调用他们的 asyncData 方法来获取数据，并在所有的 asyncData 方法全都 resolve 的时候，将全局的 state 传递给 context 带到浏览器端。</p>
<p><strong>entry-server.js</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createApp &#125; = <span class="built_in">require</span>(<span class="string">"./app"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">context</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; app, router, store &#125; = createApp();</span><br><span class="line"></span><br><span class="line">    router.push(context.url);</span><br><span class="line">    <span class="comment">// 等待路由挂载结束</span></span><br><span class="line">    router.onReady(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> matchedComponents = router.getMatchedComponents();</span><br><span class="line">      <span class="comment">// 没有匹配到路由返回404</span></span><br><span class="line">      <span class="keyword">if</span> (!matchedComponents.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(&#123;</span><br><span class="line">          code: <span class="number">404</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 遍历匹配到的组件，调用asyncData方法</span></span><br><span class="line">      <span class="built_in">Promise</span>.all(</span><br><span class="line">        matchedComponents.map(<span class="function">(<span class="params">cpt</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (cpt.asyncData) &#123;</span><br><span class="line">            cpt.asyncData(&#123;</span><br><span class="line">              store,</span><br><span class="line">              route: router.currentRoute</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      ).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 将全局的state传递给context带到浏览器端做两端状态同步</span></span><br><span class="line">        context.state = store.state;</span><br><span class="line">        <span class="comment">// 匹配到路由返回app</span></span><br><span class="line">        resolve(app);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, reject);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>renderder 对象会自动将 context 的 state 带到浏览器端，当做 window.<strong>INITIAL_STATE</strong>嵌入到 html 中，在客户端组件实例挂载前，则需要将这个 state 替换到客户端的 store 上。</p>
<h3 id="浏览器端数据预取"><a href="#浏览器端数据预取" class="headerlink" title="浏览器端数据预取"></a>浏览器端数据预取</h3><hr>
<p>为了加快数据的获取，我们可以在路由加载时就进行数据的预取，预取的方式和浏览器端相似，都是遍历调用组件的 asyncData 方法。但是对于路由来说，resolve 的时间不一致，所以这些操作要放到 router 的 beforeResolve 中进行，确保只会执行一次数据预取的操作。</p>
<p><strong>entry-client.js</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createApp &#125; = <span class="built_in">require</span>(<span class="string">"./app"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; app, router, store &#125; = createApp();</span><br><span class="line"></span><br><span class="line">router.onReady(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Ready to mount app"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在router.beforeResolve中调用确保所有的组件都被resolve</span></span><br><span class="line">  router.beforeResolve(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> matched = router.getMatchedComponents(to),</span><br><span class="line">      prevMatched = router.getMatchedComponents(<span class="keyword">from</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取没渲染过、没获取过数据的组件</span></span><br><span class="line">    <span class="keyword">const</span> actived = matched.filter(<span class="function">(<span class="params">cpt, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> prevMatched[i] !== cpt;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!actived.length) &#123;</span><br><span class="line">      next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Promise</span>.all(</span><br><span class="line">      actived.map(<span class="function">(<span class="params">cpt</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cpt.asyncData) &#123;</span><br><span class="line">          cpt.asyncData(&#123; store, <span class="attr">route</span>: to &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line">      .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 数据获取结束</span></span><br><span class="line">        next();</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(next);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把服务端的state替换到浏览器端</span></span><br><span class="line">  store.replaceState(<span class="built_in">window</span>.__INITIAL_STATE__);</span><br><span class="line">  app.$mount(<span class="string">"#app"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Store-代码拆分"><a href="#Store-代码拆分" class="headerlink" title="Store 代码拆分"></a>Store 代码拆分</h3><hr>
<p>我们可以在组件内引入对应的 store，并在执行 asyncData 的时候将其作为 module 加载到全局的 store 中</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">module</span> <span class="keyword">from</span> <span class="string">"./module"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    asyncData(&#123; isDev, route, store, env, params, query, req, res, redirect, error &#125;) &#123;</span><br><span class="line">        store.registerModule(<span class="string">"home"</span>, <span class="built_in">module</span>)</span><br><span class="line">        <span class="keyword">return</span> store.dispatch(<span class="string">"home/fetchData"</span>, route.params.id)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;style lang="scss" scoped&gt;&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><hr>
<p>部署我们采用 pm2 来做 node 端的管理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add pm2 -D</span><br></pre></td></tr></table></figure>
<p>通过 pm2 start server.js 即可启动我们的服务</p>
<h2 id="完善"><a href="#完善" class="headerlink" title="完善"></a>完善</h2><hr>
<h3 id="Friendly-errors-webpack-plugin"><a href="#Friendly-errors-webpack-plugin" class="headerlink" title="Friendly-errors-webpack-plugin"></a>Friendly-errors-webpack-plugin</h3><hr>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FriendlyErrorsPlugin = <span class="built_in">require</span>(<span class="string">"friendly-errors-webpack-plugin"</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">		...</span><br><span class="line">		plugins: [</span><br><span class="line">				<span class="keyword">new</span> FriendlyErrorsPlugin()</span><br><span class="line">		]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用此插件需要将 webpack-dev-middleware 中的 quite 设置为 true，webpack-hot-middleware 中的 log 设置为 false</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">devServerMiddleware = WebpackDevMiddleware(clientCompiler, &#123;</span><br><span class="line">  publicPath: clientConfig.output.publicPath</span><br><span class="line">&#125;);</span><br><span class="line">hotReplaceMiddleware = WebpackHotMiddleware(clientCompiler, &#123;</span><br><span class="line">  log: <span class="literal">false</span>,</span><br><span class="line">  noInfo: <span class="literal">true</span>,</span><br><span class="line">  quite: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Copy-webpack-plugin"><a href="#Copy-webpack-plugin" class="headerlink" title="Copy-webpack-plugin"></a>Copy-webpack-plugin</h3><hr>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CopyPlugin(&#123;</span><br><span class="line">  patterns: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">from</span>: <span class="string">"public"</span>,</span><br><span class="line">      to: <span class="string">"dist"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>码字不易，感恩欣赏~</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wx.png" alt="Ren 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/zfb.png" alt="Ren 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Vue/" rel="tag"># Vue</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/01/修饰符public、private和protected的区别/" rel="next" title="修饰符public、private和protected的区别">
                <i class="fa fa-chevron-left"></i> 修饰符public、private和protected的区别
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/logo.jpg" alt="Ren">
            
              <p class="site-author-name" itemprop="name">Ren</p>
              <p class="site-description motion-element" itemprop="description">不懂交互的前端不是好全栈</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Rnseia" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/1764086711?is_all=1" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
              </a>
            </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hexo.io/zh-cn/" title="Hexo文档" target="_blank">Hexo文档</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://theme-next.iissnan.com/" title="NexT文档" target="_blank">NexT文档</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是-SSR"><span class="nav-number">1.</span> <span class="nav-text">什么是 SSR?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要使用-SSR？"><span class="nav-number">2.</span> <span class="nav-text">为什么要使用 SSR？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#了解-ssr-的基本原理和渲染过程"><span class="nav-number">3.</span> <span class="nav-text">了解 ssr 的基本原理和渲染过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建一个基础的服务"><span class="nav-number">4.</span> <span class="nav-text">构建一个基础的服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#所需环境"><span class="nav-number">4.1.</span> <span class="nav-text">所需环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">4.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建页面模板"><span class="nav-number">4.3.</span> <span class="nav-text">创建页面模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建服务和-Vue-实例"><span class="nav-number">4.4.</span> <span class="nav-text">创建服务和 Vue 实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#改造"><span class="nav-number">5.</span> <span class="nav-text">改造</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#所需环境-1"><span class="nav-number">5.1.</span> <span class="nav-text">所需环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#改造后的目录结构"><span class="nav-number">5.2.</span> <span class="nav-text">改造后的目录结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#提取实例工厂，创建路由"><span class="nav-number">5.3.</span> <span class="nav-text">提取实例工厂，创建路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建客户端入口文件-entry-client-js"><span class="nav-number">5.4.</span> <span class="nav-text">创建客户端入口文件 entry-client.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建服务端入口文件-entry-server-js"><span class="nav-number">5.5.</span> <span class="nav-text">创建服务端入口文件 entry-server.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加-webpack-配置"><span class="nav-number">5.6.</span> <span class="nav-text">添加 webpack 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在-Node-中读取配置，根据-bundle-返回资源"><span class="nav-number">5.7.</span> <span class="nav-text">在 Node 中读取配置，根据 bundle 返回资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建开发环境"><span class="nav-number">6.</span> <span class="nav-text">搭建开发环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#所需环境-2"><span class="nav-number">6.1.</span> <span class="nav-text">所需环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端热更新"><span class="nav-number">6.2.</span> <span class="nav-text">服务端热更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端热更新"><span class="nav-number">6.3.</span> <span class="nav-text">客户端热更新</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志管理"><span class="nav-number">7.</span> <span class="nav-text">日志管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-1"><span class="nav-number">7.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置及封装"><span class="nav-number">7.2.</span> <span class="nav-text">配置及封装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据获取和预渲染"><span class="nav-number">8.</span> <span class="nav-text">数据获取和预渲染</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置预取工具"><span class="nav-number">8.1.</span> <span class="nav-text">配置预取工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组件的数据预取"><span class="nav-number">8.2.</span> <span class="nav-text">组件的数据预取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端数据预取"><span class="nav-number">8.3.</span> <span class="nav-text">服务端数据预取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器端数据预取"><span class="nav-number">8.4.</span> <span class="nav-text">浏览器端数据预取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Store-代码拆分"><span class="nav-number">8.5.</span> <span class="nav-text">Store 代码拆分</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署"><span class="nav-number">9.</span> <span class="nav-text">部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#完善"><span class="nav-number">10.</span> <span class="nav-text">完善</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Friendly-errors-webpack-plugin"><span class="nav-number">10.1.</span> <span class="nav-text">Friendly-errors-webpack-plugin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Copy-webpack-plugin"><span class="nav-number">10.2.</span> <span class="nav-text">Copy-webpack-plugin</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ren</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">23.4k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
 
    <span id="busuanzi_container_site_uv">
        <br>您是第
        <span id="busuanzi_value_site_uv"></span>
        个小伙伴
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        本站总浏览
        <span id="busuanzi_value_site_pv"></span>
        次
    </span>
 





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
    <span class="site-pv">
      
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


  <!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

<!-- 背景动画 -->
<script type="text/javascript" src="/js/src/particle.js"></script>

</body>
</html>
